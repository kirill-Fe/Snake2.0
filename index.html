<!DOCTYPE html>
<html>
<head>
    <title>Змейка (2.3)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0;
            padding: 10px;
            background: #222;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
            touch-action: none;
            font-family: Arial, sans-serif;
            color: white;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1/1;
            margin-bottom: 15px;
        }
        
        canvas {
            display: block;
            background: #000;
            border: 2px solid #444;
            width: 100%;
            height: 100%;
        }
        
        .score-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 400px;
            margin-bottom: 10px;
        }
        
        #score, #highScore {
            font-size: 20px;
        }
        
        .controls {
            display: grid;
            grid-template-areas:
                ". up ."
                "left down right";
            gap: 10px;
            margin: 15px 0;
            touch-action: none;
        }
        
        .control-btn {
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            color: white;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        #upBtn { grid-area: up; }
        #leftBtn { grid-area: left; }
        #downBtn { grid-area: down; }
        #rightBtn { grid-area: right; }
        
        .settings {
            width: 100%;
            max-width: 400px;
            margin-top: 10px;
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .speed-control label {
            margin-right: 10px;
            width: 80px;
        }
        
        .speed-control input {
            flex-grow: 1;
        }
        
        @media (min-width: 768px) {
            .controls {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="score-container">
        <div id="score">Счёт: 0</div>
        <div id="highScore">Рекорд: 0</div>
    </div>
    
    <div id="game-container">
        <canvas id="game"></canvas>
    </div>
    
    <div class="controls">
        <div class="control-btn" id="upBtn">↑</div>
        <div class="control-btn" id="leftBtn">←</div>
        <div class="control-btn" id="downBtn">↓</div>
        <div class="control-btn" id="rightBtn">→</div>
    </div>
    
    <div class="settings">
        <div class="speed-control">
            <label for="speedSlider">Скорость:</label>
            <input type="range" id="speedSlider" min="50" max="300" value="150" step="10">
            <span id="speedValue">150</span>
        </div>
    </div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const scoreElement = document.getElementById('score');
    const highScoreElement = document.getElementById('highScore');
    const speedSlider = document.getElementById('speedSlider');
    const speedValue = document.getElementById('speedValue');
    
    // Загрузка рекорда из localStorage
    let highScore = localStorage.getItem('snakeHighScore') || 0;
    highScoreElement.textContent = `Рекорд: ${highScore}`;
    
    // Установка размеров canvas
    function resizeCanvas() {
        const size = Math.min(window.innerWidth - 40, 400);
        canvas.width = size;
        canvas.height = size;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    // Настройки игры
    const gridSize = 20;
    let snake = [];
    let food = {};
    let dx = 0;
    let dy = 0;
    let score = 0;
    let gameSpeed = parseInt(speedSlider.value);
    let gameInterval;
    let isGameOver = false;
    let isGameStarted = false;
    
    // Обновление отображения скорости
    speedSlider.addEventListener('input', function() {
        gameSpeed = 350 - this.value; // Инвертируем (больше значение = быстрее)
        speedValue.textContent = this.value;
    });
    
    // Управление с клавиатуры
    document.addEventListener('keydown', e => {
        if (!isGameStarted) {
            isGameStarted = true;
            dx = 1;
            dy = 0;
            return;
        }
        
        switch(e.key) {
            case 'ArrowUp': if (dy !== 1) { dx = 0; dy = -1; } break;
            case 'ArrowDown': if (dy !== -1) { dx = 0; dy = 1; } break;
            case 'ArrowLeft': if (dx !== 1) { dx = -1; dy = 0; } break;
            case 'ArrowRight': if (dx !== -1) { dx = 1; dy = 0; } break;
            case ' ': if (isGameOver) startGame(); break;
        }
    });
    
    // Управление с кнопок
    const upBtn = document.getElementById('upBtn');
    const downBtn = document.getElementById('downBtn');
    const leftBtn = document.getElementById('leftBtn');
    const rightBtn = document.getElementById('rightBtn');
    
    function addButtonControl(btn, dirX, dirY) {
        const handleStart = () => {
            if (!isGameStarted) {
                isGameStarted = true;
                dx = dirX || 1;
                dy = dirY || 0;
                return;
            }
            
            if ((dirX === 0 && dirY === -1 && dy !== 1) || 
                (dirX === 0 && dirY === 1 && dy !== -1) || 
                (dirX === -1 && dirY === 0 && dx !== 1) || 
                (dirX === 1 && dirY === 0 && dx !== -1)) {
                dx = dirX;
                dy = dirY;
            }
        };
        
        btn.addEventListener('touchstart', handleStart);
        btn.addEventListener('mousedown', handleStart);
    }
    
    addButtonControl(upBtn, 0, -1);
    addButtonControl(downBtn, 0, 1);
    addButtonControl(leftBtn, -1, 0);
    addButtonControl(rightBtn, 1, 0);
    
    // Генерация еды
    function generateFood() {
        const maxPos = Math.floor(canvas.width / gridSize) - 1;
        food = {
            x: Math.floor(Math.random() * maxPos),
            y: Math.floor(Math.random() * maxPos)
        };
        
        for (let segment of snake) {
            if (segment.x === food.x && segment.y === food.y) {
                return generateFood();
            }
        }
    }
    
    // Отрисовка игры
    function draw() {
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Змейка
        ctx.fillStyle = 'lime';
        snake.forEach((segment, index) => {
            // Голова другого цвета
            if (index === 0) ctx.fillStyle = '#00FF00';
            else ctx.fillStyle = 'lime';
            
            ctx.fillRect(
                segment.x * gridSize, 
                segment.y * gridSize, 
                gridSize - 1, 
                gridSize - 1
            );
        });
        
        // Еда
        ctx.fillStyle = 'red';
        ctx.beginPath();
        ctx.arc(
            food.x * gridSize + gridSize/2,
            food.y * gridSize + gridSize/2,
            gridSize/2 - 1,
            0,
            Math.PI * 2
        );
        ctx.fill();
        
        // Стартовое сообщение
        if (!isGameStarted && !isGameOver) {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'white';
            ctx.font = '24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Нажмите любую кнопку', canvas.width/2, canvas.height/2 - 30);
            ctx.fillText('для начала игры', canvas.width/2, canvas.height/2);
            ctx.font = '16px Arial';
            ctx.fillText('Текущий рекорд: ' + highScore, canvas.width/2, canvas.height/2 + 40);
        }
    }
    
    // Игровая логика
    function gameStep() {
        if (isGameOver || !isGameStarted) return;
        
        const head = {x: snake[0].x + dx, y: snake[0].y + dy};
        
        // Столкновение со стенами
        if (head.x < 0 || head.x >= canvas.width/gridSize || 
            head.y < 0 || head.y >= canvas.height/gridSize) {
            gameOver();
            return;
        }
        
        // Столкновение с собой
        for (let i = 0; i < snake.length; i++) {
            const segment = snake[i];
            if (segment.x === head.x && segment.y === head.y) {
                gameOver();
                return;
            }
        }
        
        snake.unshift(head);
        
        // Съедание еды
        if (head.x === food.x && head.y === food.y) {
            score += 10;
            scoreElement.textContent = `Счёт: ${score}`;
            
            // Обновление рекорда
            if (score > highScore) {
                highScore = score;
                highScoreElement.textContent = `Рекорд: ${highScore}`;
                localStorage.setItem('snakeHighScore', highScore);
            }
            
            generateFood();
        } else {
            snake.pop();
        }
        
        draw();
    }
    
    function gameOver() {
        isGameOver = true;
        clearInterval(gameInterval);
        ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'white';
        ctx.font = '30px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Игра окончена!', canvas.width/2, canvas.height/2 - 40);
        ctx.font = '20px Arial';
        ctx.fillText(`Счёт: ${score}`, canvas.width/2, canvas.height/2);
        ctx.fillText('Рекорд: ' + highScore, canvas.width/2, canvas.height/2 + 30);
        ctx.fillText('Коснитесь экрана', canvas.width/2, canvas.height/2 + 70);
        ctx.fillText('для новой игры', canvas.width/2, canvas.height/2 + 100);
    }
    
    function startGame() {
        const startX = Math.floor(canvas.width/gridSize/2);
        const startY = Math.floor(canvas.height/gridSize/2);
        snake = [
            {x: startX, y: startY},
            {x: startX - 1, y: startY},
            {x: startX - 2, y: startY}
        ];
        
        dx = 1;
        dy = 0;
        score = 0;
        scoreElement.textContent = `Счёт: ${score}`;
        gameSpeed = 350 - speedSlider.value;
        isGameOver = false;
        isGameStarted = false;
        generateFood();
        clearInterval(gameInterval);
        gameInterval = setInterval(gameStep, gameSpeed);
        draw();
    }
    
    // Запуск игры при клике
    canvas.addEventListener('click', () => {
        if (isGameOver || !isGameStarted) {
            startGame();
        }
    });
    
    // Начальная инициализация
    startGame();
</script>
</body>
</html>
